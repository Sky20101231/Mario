<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Super Mario 方形版</title>
  <style>
    body { background: #222; margin: 0; overflow: hidden; }
    canvas { display: block; margin: 0 auto; background: #87ceeb; }
    #info { color: #fff; text-align: center; font-family: monospace; margin-top: 10px; }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="480"></canvas>
  <div id="info"></div>
  <script>
// 遊戲參數
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const info = document.getElementById('info');
const GRAVITY = 0.6;
const JUMP_POWER = -12;
const MOVE_SPEED = 5;
const PLAYER_SIZE = 40;
const ENEMY_SIZE = 40;
const COIN_SIZE = 20;
const GOAL_SIZE = 40;

// 多關卡資料
const levels = [
  {
    platforms: [
      {x:0, y:440, w:800, h:40},
      {x:120, y:360, w:120, h:20},
      {x:320, y:300, w:100, h:20},
      {x:500, y:220, w:120, h:20},
      {x:700, y:160, w:60, h:20},
    ],
    coins: [
      {x:140, y:320, collected:false},
      {x:350, y:260, collected:false},
      {x:530, y:180, collected:false},
      {x:720, y:120, collected:false},
    ],
    enemies: [
      {x:200, y:400, dir:1, minX:200, maxX:320, speed:2, collected:false},
      {x:520, y:180, dir:-1, minX:500, maxX:620, speed:2, collected:false},
    ],
    goal: {x:750, y:120}
  },
  {
    platforms: [
      {x:0, y:440, w:800, h:40},
      {x:200, y:360, w:100, h:20},
      {x:400, y:320, w:100, h:20},
      {x:600, y:260, w:120, h:20},
      {x:100, y:200, w:80, h:20},
    ],
    coins: [
      {x:220, y:320, collected:false},
      {x:420, y:280, collected:false},
      {x:620, y:220, collected:false},
      {x:120, y:160, collected:false},
    ],
    enemies: [
      {x:210, y:400, dir:1, minX:200, maxX:300, speed:2, collected:false},
      {x:410, y:280, dir:-1, minX:400, maxX:500, speed:2, collected:false},
    ],
    goal: {x:700, y:220}
  },
  {
    platforms: [
      {x:0, y:440, w:800, h:40},
      {x:100, y:380, w:80, h:20},
      {x:250, y:320, w:80, h:20},
      {x:400, y:260, w:80, h:20},
      {x:550, y:200, w:80, h:20},
      {x:700, y:140, w:80, h:20},
    ],
    coins: [
      {x:120, y:340, collected:false},
      {x:270, y:280, collected:false},
      {x:420, y:220, collected:false},
      {x:570, y:160, collected:false},
      {x:720, y:100, collected:false},
    ],
    enemies: [
      {x:110, y:400, dir:1, minX:100, maxX:180, speed:2, collected:false},
      {x:260, y:300, dir:1, minX:250, maxX:330, speed:2, collected:false},
      {x:410, y:240, dir:-1, minX:400, maxX:480, speed:2, collected:false},
    ],
    goal: {x:750, y:100}
  }
];
let currentLevel = 0;
let platforms = JSON.parse(JSON.stringify(levels[currentLevel].platforms));
let coins = JSON.parse(JSON.stringify(levels[currentLevel].coins));
let enemies = JSON.parse(JSON.stringify(levels[currentLevel].enemies));
let goal = Object.assign({}, levels[currentLevel].goal);
let totalScore = 0;

// 玩家
let player = {
  x: 40, y: 400, vx: 0, vy: 0, onGround: false, alive: true, win: false, score: 0
};

// 控制
const keys = {};
document.addEventListener('keydown', e => { keys[e.key.toLowerCase()] = true; });
document.addEventListener('keyup', e => { keys[e.key.toLowerCase()] = false; });

function rectsCollide(a, b, aw, ah, bw, bh) {
  return a.x < b.x + bw && a.x + aw > b.x && a.y < b.y + bh && a.y + ah > b.y;
}

function updatePlayer() {
  if (!player.alive || player.win) return;
  // 左右移動
  if (keys['a']) player.vx = -MOVE_SPEED;
  else if (keys['d']) player.vx = MOVE_SPEED;
  else player.vx = 0;
  // 跳躍
  if (keys['w'] && player.onGround) {
    player.vy = JUMP_POWER;
    player.onGround = false;
  }
  // 重力
  player.vy += GRAVITY;
  // 移動
  player.x += player.vx;
  player.y += player.vy;
  // 與平台碰撞
  player.onGround = false;
  for (const pf of platforms) {
    if (rectsCollide(player, pf, PLAYER_SIZE, PLAYER_SIZE, pf.w, pf.h)) {
      // 從上方落下
      if (player.vy > 0 && player.y + PLAYER_SIZE - player.vy <= pf.y) {
        player.y = pf.y - PLAYER_SIZE;
        player.vy = 0;
        player.onGround = true;
      } else if (player.vy < 0 && player.y >= pf.y + pf.h - 1) {
        // 從下方撞到
        player.y = pf.y + pf.h;
        player.vy = 0;
      } else if (player.x + PLAYER_SIZE - player.vx <= pf.x) {
        // 從左撞到
        player.x = pf.x - PLAYER_SIZE;
      } else if (player.x - player.vx >= pf.x + pf.w) {
        // 從右撞到
        player.x = pf.x + pf.w;
      }
    }
  }
  // 不要出界
  if (player.x < 0) player.x = 0;
  if (player.x + PLAYER_SIZE > canvas.width) player.x = canvas.width - PLAYER_SIZE;
  if (player.y > canvas.height) player.alive = false;
}

function updateEnemies() {
  for (const e of enemies) {
    if (e.collected) continue;
    e.x += e.dir * e.speed;
    if (e.x < e.minX) { e.x = e.minX; e.dir = 1; }
    if (e.x > e.maxX) { e.x = e.maxX; e.dir = -1; }
    // 與玩家碰撞
    if (!e.collected && rectsCollide(player, e, PLAYER_SIZE, PLAYER_SIZE, ENEMY_SIZE, ENEMY_SIZE)) {
      e.collected = true;
      player.score++;
    }
  }
}

function updateCoins() {
  for (const c of coins) {
    if (!c.collected && rectsCollide(player, c, PLAYER_SIZE, PLAYER_SIZE, COIN_SIZE, COIN_SIZE)) {
      c.collected = true;
      player.score++;
    }
  }
}

function checkGoal() {
  if (rectsCollide(player, goal, PLAYER_SIZE, PLAYER_SIZE, GOAL_SIZE, GOAL_SIZE)) {
    totalScore += player.score;
    if (currentLevel < levels.length - 1) {
      player.score = 0;
      resetLevel(true);
    } else {
      player.win = true;
    }
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  // 平台
  ctx.fillStyle = '#964B00';
  for (const pf of platforms) {
    ctx.fillRect(pf.x, pf.y, pf.w, pf.h);
  }
  // 金幣
  for (const c of coins) {
    if (!c.collected) {
      ctx.fillStyle = 'gold';
      ctx.beginPath();
      ctx.arc(c.x + COIN_SIZE/2, c.y + COIN_SIZE/2, COIN_SIZE/2, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = '#bfa500';
      ctx.stroke();
    }
  }
  // 蘑菇敵人
  for (const e of enemies) {
    if (e.collected) continue;
    ctx.fillStyle = '#d22';
    ctx.fillRect(e.x, e.y, ENEMY_SIZE, ENEMY_SIZE);
    ctx.fillStyle = '#fff';
    ctx.fillRect(e.x+8, e.y+8, 24, 12); // 蘑菇臉
    ctx.fillStyle = '#222';
    ctx.fillRect(e.x+14, e.y+14, 4, 4); // 眼睛
    ctx.fillRect(e.x+22, e.y+14, 4, 4);
  }
  // 終點
  ctx.fillStyle = '#0c0';
  ctx.fillRect(goal.x, goal.y, GOAL_SIZE, GOAL_SIZE);
  ctx.fillStyle = '#fff';
  ctx.font = '20px monospace';
  ctx.fillText('GOAL', goal.x-10, goal.y-10);
  // 玩家
  if (player.alive) {
    ctx.fillStyle = '#09f';
    ctx.fillRect(player.x, player.y, PLAYER_SIZE, PLAYER_SIZE);
  }
}

function showInfo() {
  if (player.win && currentLevel >= levels.length-1) info.innerHTML = `全部過關！總分：${totalScore + player.score} <br> 按F5重新開始`;
  else if (!player.alive) info.innerHTML = `失敗！分數：${totalScore + player.score} <br> 按F5重新開始`;
  else info.innerHTML = `關卡：${currentLevel+1} / ${levels.length}　分數：${totalScore + player.score}`;
}

function resetLevel(next) {
  if (next) currentLevel++;
  if (currentLevel >= levels.length) {
    player.win = true;
    return;
  }
  platforms = JSON.parse(JSON.stringify(levels[currentLevel].platforms));
  coins = JSON.parse(JSON.stringify(levels[currentLevel].coins));
  enemies = JSON.parse(JSON.stringify(levels[currentLevel].enemies));
  goal = Object.assign({}, levels[currentLevel].goal);
  player.x = 40; player.y = 400; player.vx = 0; player.vy = 0; player.onGround = false; player.win = false; player.alive = true;
}

function gameLoop() {
  updatePlayer();
  updateEnemies();
  updateCoins();
  checkGoal();
  draw();
  showInfo();
  requestAnimationFrame(gameLoop);
}

// 初始化
resetLevel(false);
gameLoop();
  </script>
</body>
</html> 